{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceGroupIot": {
            "type": "String",
			"metadata": {
      				"description": "Enter the name of resource group to be created for Iot hub."
    }
        },
        "resourceGroupDevice": {
            "type": "String",
			"metadata": {
      				"description": "Enter the name of resource group to be created for Edge device."
    }
        },
        "resourceGroupLocation": {
            "defaultValue": "East US",
            "type": "String",
			"metadata": {
      				"description": "Location for all resources."
    }
        },
		"deviceArchitecture": {
			"allowedValues": [
				"X86",
				"ARM64"
				],
            "type": "String",
			"metadata": {
      				"description": "Specify the architecture of the Edge Device. Currently supported values are 'X86' and 'ARM64'."
    }
        },
		"moduleRuntime": {
			"allowedValues": [
				"CPU",
				"NVIDIA",
				"MOVIDIUS"
				],
            "type": "String",
			"metadata": {
      				"description": "Select value for runtime for Detector module on Edge Device. Set it to 'CPU' to use CPU to run detector module. If the Edge Device has Nvidia GPU, set it to 'NVIDIA' to use GPU to run detector module or to use movidius set it to 'MOVIDIUS'."
    }
        },
        "Password": {
            "defaultValue": "UnifiedEdge2020",
            "type": "String",
			"metadata": {
      				"description": "Specify the password for the web app."
                }
        },
        "managedIdentityResourceGroup":{
            "type": "String",
            "metadata":{
                "description": "Specify the resource group name where user managed identity has been created"
            }
        },
        "managedIdentityName":{
            "type": "String",
            "metadata":{
                "description": "Specify the name of user managed identity present in Managed Identity Resource Group"
            }
        },
		"useExistingEdgeDevice" :{
			"allowedValues": [
				"Yes",
				"No"
				],
            "type": "String",
			"metadata": {
      				"description": "Select whether you want to create the edge device or skip this part and use existing resources."
		}
		},
		"existingIotHubName" :{
			"defaultValue":"",
			"type":"String",
			"metadata": {
      				"description": "Enter the name of existing iot hub to be used."
		}
		},
		"existingDeviceName" :{
			"defaultValue":"",
			"type":"String",
			"metadata": {
      				"description": "Enter the name of existing device to be used."
		}
		}
    },
    "variables": {
        "webappName": "[concat('ues-eyeapp',substring(uniqueString(subscription().id,parameters('resourceGroupIot')),1,4))]",
        "appServiceName": "[concat('ues-eyeasp',substring(uniqueString(subscription().id,parameters('resourceGroupIot')),1,4))]",
        "diskName": "mariner",
		"deviceName" : "[if(equals(parameters('existingDeviceName'), ''), 'azureEyeEdgeDevice', parameters('existingDeviceName'))]",
        "networkSecurityGroupName": "default-NSG",
        "vmName": "marinervm",
        "nicName": "marinervmVMNic",
        "virtualNetworkName": "MyVNET",
        "subnetName": "Subnet",
        "addressPrefix": "10.0.0.0/16",
        "subnetPrefix": "10.0.0.0/24",
        "publicIPAddressName": "myPublicIP",
        "resourceGroupIot": "[if(equals(parameters('resourceGroupIot'), parameters('resourceGroupDevice')), 'storage', parameters('resourceGroupDevice'))]",
        "resourceGroupDevice": "[parameters('resourceGroupIot')]",
		"storageAccountName": "[concat('uesstorage',substring(uniqueString(subscription().id,parameters('resourceGroupIot')),1,4))]",
		"iothublogic":"[if(equals(parameters('existingIotHubName'), ''), 'azureeyeiothub', parameters('existingIotHubName'))]",
		"iotHubName": "[if(equals(parameters('existingIotHubName'),variables('iothublogic')),parameters('existingIotHubName'),concat(variables('iothublogic'),substring(uniqueString(subscription().id,parameters('resourceGroupIot')),1,4)))]",
		"deploymentName" :"[concat('eye-deployment',substring(uniqueString(subscription().id,parameters('resourceGroupIot')),1,4))]",
		"customVideoSource": ""
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('resourceGroupDevice')]",
            "location": "[parameters('resourceGroupLocation')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('resourceGroupIot')]",
            "location": "[parameters('resourceGroupLocation')]",
            "properties": {},
			"condition": "[not(equals(parameters('resourceGroupIot'),parameters('resourceGroupDevice')))]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "diskVMDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('resourceGroupDevice'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Compute/disks",
                            "apiVersion": "2019-07-01",
                            "name": "[variables('diskName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "sku": {
                                "name": "Premium_LRS",
                                "tier": "Premium"
                            },
                            "properties": {
                                "osType": "Linux",
                                "hyperVGeneration": "V2",
                                "creationData": {
                                    "createOption": "Upload",
                                    "uploadSizeBytes": 68719477248
                                },
                                "diskIOPSReadWrite": 240,
                                "diskMBpsReadWrite": 50,
                                "encryption": {
                                    "type": "EncryptionAtRestWithPlatformKey"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2019-10-01-preview",
                            "name": "scriptforcopy",
                            "dependsOn": [
                                "[variables('diskName')]"
                            ],
                            "location": "[parameters('resourceGroupLocation')]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[concat(subscription().id,'/resourceGroups/', parameters('managedIdentityResourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',parameters('managedIdentityName'))]": {}
                                }
                            },
                            "properties": {
                                "forceUpdateTag": "1",
                                "azCliVersion": "2.9.1",
                                "primaryScriptUri": "https://unifiededgescenariostest.blob.core.windows.net/arm-template/disk-setup.sh",
                                "supportingScriptUris": [],
                                "environmentVariables": [
                                    {
                                        "name": "RESOURCE_GROUP_DEVICE",
                                        "value": "[parameters('resourceGroupDevice')]"
                                    },
                                    {
                                        "name": "DISK_NAME",
                                        "value": "[variables('diskName')]"
                                    }
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT15M",
                                "containerSettings": {},
                                "cleanupPreference": "OnSuccess"
                            }
                        },
                        {
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2019-08-01",
                            "name": "[variables('networkSecurityGroupName')]",
                            "location": "[parameters('resourceGroupLocation')]"
                        },
                        {
                            "type": "Microsoft.Network/publicIPAddresses",
                            "apiVersion": "2018-11-01",
                            "name": "[variables('publicIPAddressName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "properties": {
                                "publicIPAllocationMethod": "Dynamic"
                            }
                        },
						{
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2018-11-01",
                            "name": "[variables('virtualNetworkName')]",
                            "location": "[parameters('resourceGroupLocation')]",
							"dependsOn": [
                                "[variables('networkSecurityGroupName')]"
                            ],
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "[variables('addressPrefix')]"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "[variables('subnetName')]",
                                        "properties": {
                                            "addressPrefix": "[variables('addressPrefix')]",
                                            "networkSecurityGroup": {
                                                "id": "[concat(subscription().id,'/resourceGroups/', parameters('resourceGroupDevice'),'/providers/Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]"
                                            }
                                        }
                                    }
                                ]
                            }
                        },
						{
                            "type": "Microsoft.Network/networkInterfaces",
                            "apiVersion": "2018-11-01",
                            "name": "[variables('nicName')]",
                            "location": "[parameters('resourceGroupLocation')]",
							"dependsOn": [
                                "[variables('virtualNetworkName')]",
								"[variables('publicIPAddressName')]"
                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "ipconfig1",
                                        "properties": {
                                            "privateIPAllocationMethod": "Dynamic",
                                            "publicIPAddress": {
                                                "id": "[concat(subscription().id,'/resourceGroups/', parameters('resourceGroupDevice'),'/providers/Microsoft.Network/publicIPAddresses/',variables('publicIPAddressName'))]"
                                            },
                                            "subnet": {
                                                "id": "[concat(subscription().id,'/resourceGroups/', parameters('resourceGroupDevice'),'/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'),'/subnets/', variables('subnetName'))]"
                                            }
                                        }
                                    }
                                ]
                            }
                        },
						{
                            "type": "Microsoft.Compute/virtualMachines",
                            "apiVersion": "2019-07-01",
                            "name": "[variables('vmName')]",
                            "location": "[parameters('resourceGroupLocation')]",
							"dependsOn": [
                                "[variables('diskName')]",
								"[variables('nicName')]",
								"scriptforcopy"
                            ],
                            "properties": {
                                "hardwareProfile": {
                                    "vmSize": "Standard_DS2_v2"
                                },
                                "storageProfile": {
                                    "osDisk": {
                                        "osType": "Linux",
                                        "name": "[variables('diskName')]",
                                        "createOption": "Attach",
                                        "caching": "ReadWrite",
                                        "managedDisk": {
                                            "storageAccountType": "Premium_LRS",
                                            "id": "[concat(subscription().id,'/resourceGroups/', parameters('resourceGroupDevice'),'/providers/Microsoft.Compute/disks/', variables('diskName'))]"
                                        },
                                        "diskSizeGB": 64
                                    },
                                    "dataDisks": []
                                },
                                "networkProfile": {
                                    "networkInterfaces": [
                                        {
                                            "id": "[concat(subscription().id,'/resourceGroups/', parameters('resourceGroupDevice'),'/providers/Microsoft.Network/networkInterfaces/', variables('nicName'))]"
                                        }
                                    ]
                                }
                            }
                        }
                    ],
                    "outputs": {}
                }
            },
			"condition": "[equals(parameters('useExistingEdgeDevice'),'No')]",
            "resourceGroup": "[parameters('resourceGroupDevice')]"
        },
		{
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "IothubDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('resourceGroupIot'))]",
				"diskVMDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [						
						{
                            "type": "Microsoft.Devices/IotHubs",
                            "apiVersion": "2020-04-01",
                            "name": "[variables('iotHubName')]",
							"dependsOn": [],
                            "location": "[parameters('resourceGroupLocation')]",
                            "sku": {
                                "name": "S1",
                                "tier": "Standard",
                                "capacity": 1
                            },
                            "identity": {
                                "type": "None"
                            },
                            "properties": {
                                "ipFilterRules": [],
                                "eventHubEndpoints": {
                                    "events": {
                                        "retentionTimeInDays": 1,
                                        "partitionCount": 4
                                    }
                                },
                                "routing": {
                                    "endpoints": {},
                                    "routes": [],
                                    "fallbackRoute": {
                                        "name": "$fallback",
                                        "source": "DeviceMessages",
                                        "condition": "true",
                                        "endpointNames": [
                                            "events"
                                        ],
                                        "isEnabled": true
                                    }
                                }
                            }
                        },
						{
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2019-10-01-preview",
                            "name": "configureEdgeDevice",
                            "dependsOn": [
								"[variables('iotHubName')]"
							],
                            "location": "[parameters('resourceGroupLocation')]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[concat(subscription().id,'/resourceGroups/', parameters('managedIdentityResourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',parameters('managedIdentityName'))]": {}
                                }
                            },
                            "properties": {
                                "forceUpdateTag": "1",
                                "azCliVersion": "2.9.1",
                                "primaryScriptUri": "https://unifiededgescenariostest.blob.core.windows.net/arm-template/create-setup-iot-edge-device.sh",
                                "supportingScriptUris": [],
                                "environmentVariables": [
                                    {
                                        "name": "RESOURCE_GROUP_DEVICE",
                                        "value": "[parameters('resourceGroupDevice')]"
                                    },
                                    {
                                        "name": "VM_NAME",
                                        "value": "[variables('vmName')]"
                                    },									
									{
                                        "name": "IOTHUB_NAME",
                                        "value": "[variables('iotHubName')]"
                                    },									
									{
										"name": "NSG_NAME",
										"value": "[variables('networkSecurityGroupName')]"
									},
									{
										"name": "DEVICE_NAME",
										"value" : "[variables('deviceName')]"
									}
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT15M",
                                "containerSettings": {},
                                "cleanupPreference": "OnSuccess"
                            }
                        }
                    ],
                    "outputs": {}
                }
            },
			"condition": "[equals(parameters('useExistingEdgeDevice'),'No')]",
            "resourceGroup": "[parameters('resourceGroupIot')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "resourcesDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('resourceGroupIot'))]",
                "diskVMDeployment",
				"IothubDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "resourceGroupIot": {
                        "value": "[parameters('resourceGroupIot')]"
                    },
                    "StorageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
					"iotHubName": {
						"value": "[variables('iotHubName')]"
					},
                    "resourceGroupLocation": {
                        "value": "[parameters('resourceGroupLocation')]"
                    },
                    "accountType": {
                        "value": "Standard_RAGRS"
                    },
                    "kind": {
                        "value": "StorageV2"
                    },
                    "isHnsEnabled": {
                        "value": true
                    },
                    "accountSasProperties": {
                        "value": {
                            "signedServices": "b",
                            "signedPermission": "lr",
                            "signedExpiry": "2021-01-01T00:00:01Z",
                            "signedResourceTypes": "sco"
                        }
                    },
                    "deviceArchitecture": {
                        "value": "[parameters('deviceArchitecture')]"
                    },
                    "moduleRuntime": {
                        "value": "[parameters('moduleRuntime')]"
                    },
					"managedIdentityResourceGroup": {
						"value": "[parameters('managedIdentityResourceGroup')]"
					},
					"managedIdentityName": {
						"value": "[parameters('managedIdentityName')]"
					},
                    "customVideoSource": {
                        "value": "[variables('customVideoSource')]"
                    },
					"deviceName":{
						"value" : "[variables('deviceName')]"
					},
					"deploymentName":{
						"value": "[variables('deploymentName')]"
					}
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "resourceGroupIot": {
                            "type": "String"
                        },
                        "StorageAccountName": {
                            "type": "String"
                        },
						"iotHubName": {
                            "type": "string"
                        },
                        "resourceGroupLocation": {
                            "type": "String"
                        },
                        "accountType": {
                            "type": "String"
                        },
                        "kind": {
                            "type": "String"
                        },
                        "isHnsEnabled": {
                            "type": "Bool"
                        },
                        "accountSasProperties": {
                            "type": "Object"
                        },
                        "deviceArchitecture": {
                            "type": "String"
                        },
                        "moduleRuntime": {
                            "type": "String"
                        },
						"managedIdentityResourceGroup": {
							"type": "String"
						},
						"managedIdentityName": {
							"type": "String"
						},
                        "customVideoSource": {
                            "type": "String"
                        },
						"deviceName":{
							"type": "String"
						},
						"deploymentName":{
							"type": "String"
						}
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2019-06-01",
                            "name": "[parameters('StorageAccountName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "dependsOn": [],
                            "tags": {},
                            "sku": {
                                "name": "[parameters('accountType')]"
                            },
                            "kind": "[parameters('kind')]",
                            "properties": {
                                "accessTier": "Hot",
                                "minimumTlsVersion": "TLS1_0",
                                "supportsHttpsTrafficOnly": true,
                                "allowBlobPublicAccess": true,
                                "networkAcls": {
                                    "bypass": "AzureServices",
                                    "defaultAction": "Allow",
                                    "ipRules": []
                                },
                                "isHnsEnabled": "[parameters('isHnsEnabled')]"
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices",
                            "apiVersion": "2019-06-01",
                            "name": "[concat(parameters('StorageAccountName'), '/default')]",
                            "dependsOn": [
                                "[parameters('storageAccountName')]"
                            ],
                            "sku": {
                                "name": "Standard_RAGRS",
                                "tier": "Standard"
                            },
                            "properties": {
                                "cors": {
                                    "corsRules": [
                                        {
                                            "allowedOrigins": [
                                                "*"
                                            ],
                                            "allowedMethods": [
                                                "GET",
                                                "HEAD"
                                            ],
                                            "maxAgeInSeconds": 1000,
                                            "exposedHeaders": [
                                                "*"
                                            ],
                                            "allowedHeaders": [
                                                "*"
                                            ]
                                        }
                                    ]
                                },
                                "deleteRetentionPolicy": {
                                    "enabled": false
                                }
                            }
                        },
						{
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "2019-06-01",
                            "name": "[concat(parameters('storageAccountName'), '/default/detectoroutput')]",
                            "dependsOn": [
								"[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
								"[parameters('storageAccountName')]"
							],
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "2019-06-01",
                            "name": "[concat(parameters('storageAccountName'), '/default/still-images')]",
                            "dependsOn": [
								"[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
								"[parameters('storageAccountName')]"
							],
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
						{
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2019-10-01-preview",
                            "name": "moduleDeployment",
                            "dependsOn": [
								"[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), 'default','detectoroutput')]",
								"[parameters('storageAccountName')]"
							],
                            "location": "[parameters('resourceGroupLocation')]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[concat(subscription().id,'/resourceGroups/', parameters('managedIdentityResourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',parameters('managedIdentityName'))]": {}
                                }
                            },
                            "properties": {
                                "forceUpdateTag": "1",
                                "azCliVersion": "2.9.1",
                                "primaryScriptUri": "https://unifiededgescenariostest.blob.core.windows.net/arm-template/deploy-modules.sh",
                                "supportingScriptUris": [],
                                "environmentVariables": [
                                   
									{
                                        "name": "DETECTOR_MODULE_RUNTIME",
                                        "value": "[parameters('moduleRuntime')]"
                                    },
									{
                                        "name": "EDGE_DEVICE_ARCHITECTURE",
                                        "value": "[parameters('deviceArchitecture')]"
                                    },
									{
                                        "name": "IOTHUB_NAME",
                                        "value": "[parameters('iotHubName')]"
                                    },
									{
                                        "name": "STORAGE_ACCOUNT_NAME",
                                        "value": "[parameters('StorageAccountName')]"
                                    },
									{
                                        "name": "RESOURCE_GROUP_IOT",
                                        "value": "[parameters('resourceGroupIot')]"
                                    },									
									{
										"name": "CUSTOM_VIDEO_SOURCE",
										"value": "[parameters('customVideoSource')]"
									},
									{
										"name": "DEVICE_NAME",
										"value" : "[parameters('deviceName')]"
									},
									{
										"name": "DEPLOYMENT_NAME",
										"value": "[parameters('deploymentName')]"
									}
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT15M",
                                "containerSettings": {},
                                "cleanupPreference": "OnSuccess"
                            }
                        }
                    ],
                    "outputs": {
                        "sasToken": {
                            "type": "string",
                            "value": "[listAccountSas(parameters('StorageAccountName'), '2018-07-01', parameters('accountSasProperties')).accountSasToken]"
                        },
                        "IoTHubConnectionString": {
                            "type": "string",
                            "value": "[concat('HostName=', reference(resourceId('Microsoft.Devices/IoTHubs', parameters('iotHubName')), providers('Microsoft.Devices', 'IoTHubs').apiVersions[0]).hostName, ';SharedAccessKeyName=iothubowner;SharedAccessKey=', listKeys(resourceId('Microsoft.Devices/IotHubs', parameters('iotHubName')), providers('Microsoft.Devices', 'IoTHubs').apiVersions[0]).value[0].primaryKey)]"
                        }
                    }
                }
            },
            "resourceGroup": "[parameters('resourceGroupIot')]"
        },
		{
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "appServicePlanDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('resourceGroupIot'))]",
				"resourcesDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Web/serverfarms",
                            "apiVersion": "2018-02-01",
                            "name": "[variables('appServiceName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "sku": {
                                "name": "S1",
                                "tier": "Standard",
                                "size": "S1",
                                "family": "S",
                                "capacity": 1
                            },
                            "kind": "app",
                            "properties": {
                                "perSiteScaling": false,
                                "maximumElasticWorkerCount": 1,
                                "isSpot": false,
                                "reserved": false,
                                "isXenon": false,
                                "hyperV": false,
                                "targetWorkerCount": 0,
                                "targetWorkerSizeId": 0
                            }
                        },
						{
                            "type": "Microsoft.Web/sites",
                            "apiVersion": "2018-11-01",
                            "name": "[variables('webappName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "dependsOn": [
								"[variables('appServiceName')]"
							],
                            "kind": "app",
                            "properties": {
                                "enabled": true,
                                "hostNameSslStates": [
                                    {
                                        "name": "[concat(variables('webappName'), '.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Standard"
                                    },
                                    {
                                        "name": "[concat(variables('webappName'), '.scm.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Repository"
                                    }
                                ],
                                "serverFarmId": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupIot'),'/providers/Microsoft.Web/serverfarms/', variables('appServiceName'))]",
                                "reserved": false,
                                "isXenon": false,
                                "hyperV": false,
                                "siteConfig": {},
                                "scmSiteAlsoStopped": false,
                                "clientAffinityEnabled": true,
                                "clientCertEnabled": false,
                                "hostNamesDisabled": false,
                                "containerSize": 0,
                                "dailyMemoryTimeQuota": 0,
                                "httpsOnly": false,
                                "redundancyMode": "None"
                            },
                            "resources": [
                                {
                                    "type": "config",
                                    "apiVersion": "2018-11-01",
                                    "name": "web",
                                    "dependsOn": [
                                        "[variables('webappName')]",
                                        "MSDeploy"
                                    ],
                                    "properties": {
                                        "webSocketsEnabled": true,
                                        "alwaysOn": true
                                    }
                                },
                                {
                                    "name": "connectionstrings",
                                    "type": "config",
                                    "apiVersion": "2020-06-01",
                                    "dependsOn": [
                                        "[variables('webappName')]",
                                        "MSDeploy"
                                    ],
                                    "properties": {
                                        "EventHub": {
                                            "value": "[reference('resourcesDeployment').outputs.IoTHubConnectionString.value]",
                                            "type": "Custom"
                                        }
                                    }
                                },
                                {
                                    "type": "config",
                                    "apiVersion": "2018-11-01",
                                    "name": "appsettings",
                                    "dependsOn": [
                                        "[variables('webappName')]",
                                        "MSDeploy"
                                    ],
                                    "properties": {
                                        "STORAGE_BLOB_ACCOUNT": "[variables('storageAccountName')]",
                                        "PASSWORD": "[parameters('Password')]",
                                        "WEBSITE_HTTPLOGGING_RETENTION_DAYS": "7",
                                        "WEBSITE_NODE_DEFAULT_VERSION": "10.15.2",
                                        "STORAGE_BLOB_CONTAINER_NAME": "still-images",
                                        "STORAGE_BLOB_PATH": "Office/cam001",
                                        "STORAGE_BLOB_SHARED_ACCESS_SIGNATURE": "[reference('resourcesDeployment').outputs.sasToken.value]"
                                    }
                                },
                                {
                                    "type": "Extensions",
                                    "apiVersion": "2018-11-01",
                                    "name": "MSDeploy",
                                    "location": "[parameters('resourceGroupLocation')]",
                                    "dependsOn": [
                                        "[variables('webappName')]"
                                    ],
                                    "properties": {
                                        "packageUri": "https://unifiededgescenariostest.blob.core.windows.net/test/people-detection-app.zip"
                                    }
                                }
                            ]
                        }						
                    ]
                }
            },
            "resourceGroup": "[parameters('resourceGroupIot')]"
        }
    ]
}